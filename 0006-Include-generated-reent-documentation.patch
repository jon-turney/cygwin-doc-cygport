From 218e4f2f0b2699a6628d31e59e99e00be93be820 Mon Sep 17 00:00:00 2001
From: Jon Turney <jon.turney@dronecode.org.uk>
Date: Sat, 18 Jul 2015 18:43:15 +0100
Subject: [PATCH 6/8] Include generated reent documentation

Signed-off-by: Jon Turney <jon.turney@dronecode.org.uk>
---
 newlib/libc/libc.in.xml       |  1 +
 newlib/libc/reent/Makefile.am | 24 +++++++++++++++++++-----
 newlib/libc/reent/reent.tex   |  4 ++--
 3 files changed, 22 insertions(+), 7 deletions(-)

diff --git a/newlib/libc/libc.in.xml b/newlib/libc/libc.in.xml
index f83f6ab..885d3b9 100644
--- a/newlib/libc/libc.in.xml
+++ b/newlib/libc/libc.in.xml
@@ -125,6 +125,7 @@
   <xi:include href="time.xml"/>
   <xi:include href="locale.xml"/>
   <!-- reent.tex contains fixed content and nothing seems to include the .def made in reent/ -->
+  <xi:include href="reent.xml"/>
 
   <xi:include href="misc.xml"/>
   <!-- posix is optional -->
diff --git a/newlib/libc/reent/Makefile.am b/newlib/libc/reent/Makefile.am
index 9e0602d..42d65a1 100644
--- a/newlib/libc/reent/Makefile.am
+++ b/newlib/libc/reent/Makefile.am
@@ -90,19 +90,33 @@ CHEWOUT_FILES = \
 	$(STDIO64_DEFS) \
 	writer.def
 
-SUFFIXES = .def .h
+SUFFIXES = .def .xml .h
 
 CHEW = ../../doc/makedoc -f $(srcdir)/../../doc/doc.str
 
 .c.def:
 	$(CHEW) < $< > $*.def 2> $*.ref
-	touch stmp-def
+	@touch stmp-def
 
+CHAPTER = reent.tex
 TARGETDOC = ../tmp.texi
 
-doc: $(CHEWOUT_FILES)
-	cat $(srcdir)/reent.tex >> $(TARGETDOC)
+doc-texinfo: $(CHEWOUT_FILES)
+	cat $(srcdir)/$(CHAPTER) >> $(TARGETDOC)
+
+DOCBOOK_CHEW = ${srcdir}/../../doc/makedocbook.py
+DOCBOOK_OUT_FILES = $(CHEWOUT_FILES:.def=.xml)
+DOCBOOK_CHAPTER = ${CHAPTER:.tex=.xml}
+
+.c.xml:
+	$(DOCBOOK_CHEW) < $< > $*.xml || ( rm $*.xml && false )
+	@touch stmp-xml
+
+doc-docbook: $(DOCBOOK_OUT_FILES)
+	${srcdir}/../../doc/chapter-texi2docbook.py <$(srcdir)/${CHAPTER} >../${DOCBOOK_CHAPTER}
+
+doc: doc-docbook doc-texinfo
 
 $(lpfx)impure.$(oext): $(srcdir)/impure.c $(srcdir)/../include/sys/reent.h
 
-CLEANFILES = $(CHEWOUT_FILES) *.ref
+CLEANFILES = $(CHEWOUT_FILES) *.ref $(DOCBOOK_OUT_FILES)
diff --git a/newlib/libc/reent/reent.tex b/newlib/libc/reent/reent.tex
index 881c572..12597be 100644
--- a/newlib/libc/reent/reent.tex
+++ b/newlib/libc/reent/reent.tex
@@ -15,8 +15,8 @@ reentrant fashion.
 @findex reent.h
 @cindex reentrancy structure
 These hooks use the structure @code{_reent} defined in @file{reent.h}.
-A variable defined as @samp{struct _reent} is called a @dfn{reentrancy
-structure}.  All functions which must manipulate global information are
+A variable defined as @samp{struct _reent} is called a @dfn{reentrancy structure}.
+All functions which must manipulate global information are
 available in two versions.  The first version has the usual name, and
 uses a single global instance of the reentrancy structure.  The second
 has a different name, normally formed by prepending @samp{_} and
-- 
2.5.3

